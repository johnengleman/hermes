//@version=5
strategy("Hermes SIMPLE Strategy", overlay=false, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, pyramiding=1, calc_on_every_tick=false, calc_on_order_fills=false, process_orders_on_close=true)

// ============================================================================
// 📊 OPTIMIZER PARAMETERS - Update these with optimizer results
// ============================================================================
// These match the SIMPLE_MODE optimizer output columns exactly
// Current values are DEFAULTS (manual testing: 150,000% with macro filter OFF)

// ALMA Periods
short_period = input.int(30, "Short Period", minval=10, maxval=150, group="ALMA")
long_period = input.int(250, "Long Period", minval=100, maxval=400, group="ALMA")

// ALMA Settings (fixed for all conditions)
alma_offset = input.float(0.95, "ALMA Offset", minval=0.80, maxval=0.99, step=0.01, group="ALMA")
alma_sigma = input.float(4.0, "ALMA Sigma", minval=2.0, maxval=10.0, step=1.0, group="ALMA")

// Price Structure Filters
fast_hma_period = input.int(30, "Fast HMA Period", minval=10, maxval=100, group="Price Structure")
slow_ema_period = input.int(80, "Slow EMA Period", minval=30, maxval=200, group="Price Structure")

// Entry Filters
momentum_lookback = input.int(1, "Momentum Lookback", minval=1, maxval=10, group="Entry Filters",
     tooltip="Lookback for momentum confirmation")
slow_ema_rising_lookback = input.int(3, "Slow EMA Rising Lookback", minval=1, maxval=15, group="Entry Filters",
     tooltip="Slow EMA must be rising over this period")

// Macro Filter (🔥 KEY: Disable this for best results!)
use_macro_filter = input.bool(false, "Use Macro Filter", group="Entry Filters",
     tooltip="⚠️ DISABLE THIS FOR 150,000% RETURNS! Enable for conservative 140,000%")
macro_ema_period = input.int(100, "Macro EMA Period", minval=50, maxval=250, group="Entry Filters",
     tooltip="Only used if macro filter is enabled")

// Display
use_momentum_filters = input.bool(true, "Use Momentum Filters", group="Display")
show_debug = input.bool(true, "Show Debug Info", group="Display")

// ============================================================================
// CALCULATIONS
// ============================================================================

// Log returns for ALMA
daily_return = na(close[1]) ? 1.0 : close / close[1]
log_return = math.log(daily_return)

// ALMA signals (fixed parameters for all conditions)
long_term = ta.alma(log_return, long_period, alma_offset, alma_sigma)
short_term = ta.alma(log_return, short_period, alma_offset, alma_sigma)
baseline = long_term

// Price structure
fast_hma = ta.hma(close, fast_hma_period)
slow_ema = ta.ema(close, slow_ema_period)

// Macro filter
macro_ema = ta.ema(close, macro_ema_period)
in_bull_market = close > macro_ema

// ============================================================================
// ENTRY SIGNALS
// ============================================================================

bullish_state = short_term > baseline
bearish_state = short_term < baseline

// Momentum filters
is_highest_close = close >= ta.highest(close[1], momentum_lookback) and high >= ta.highest(high[1], momentum_lookback)
is_lowest_low = low <= ta.lowest(low[1], momentum_lookback) and close <= ta.lowest(close[1], momentum_lookback)

// Slow EMA rising
slow_ema_rising = slow_ema > slow_ema[slow_ema_rising_lookback]

// Build buy signal
buy_signal = bullish_state

if use_momentum_filters
    buy_signal := buy_signal and is_highest_close

if use_macro_filter
    buy_signal := buy_signal and in_bull_market

buy_signal := buy_signal and slow_ema_rising

// Build sell signal
sell_signal = bearish_state
if use_momentum_filters
    sell_signal := sell_signal and is_lowest_low

// ============================================================================
// POSITION TRACKING
// ============================================================================

in_position = strategy.position_size > 0
var bool trending_regime = false

if not in_position
    trending_regime := false

// ============================================================================
// ENTRY
// ============================================================================

if buy_signal and not in_position
    strategy.entry("Long", strategy.long)
    trending_regime := false

// ============================================================================
// EXIT LOGIC
// ============================================================================

var bool trending_exit_trigger = false
var bool ranging_exit_trigger = false

if in_position
    trending_exit_trigger := false
    ranging_exit_trigger := false
    position_entry_price = strategy.position_avg_price

    // Trending regime detection
    trending_setup = slow_ema > position_entry_price and fast_hma > position_entry_price and fast_hma > slow_ema
    trend_cross_under = ta.crossunder(fast_hma, slow_ema)

    if trending_setup
        trending_regime := true
    else if not trend_cross_under
        trending_regime := false

    // Trending exit
    sell_momentum_ok = not use_momentum_filters or is_lowest_low
    close_below_entry = close < position_entry_price
    normal_trending_exit = trend_cross_under and sell_momentum_ok
    trending_exit = trending_regime and (close_below_entry or normal_trending_exit)

    // Ranging exit
    ranging_exit = not trending_regime and sell_signal

    // Execute exit
    exit_signal = trending_exit or ranging_exit

    if exit_signal
        trending_exit_trigger := trending_exit
        ranging_exit_trigger := ranging_exit
        strategy.close("Long")
        trending_regime := false
else
    trending_exit_trigger := false
    ranging_exit_trigger := false

// ============================================================================
// PLOTTING
// ============================================================================

plot(short_term, title="Short-Term Signal", color=color.blue, linewidth=2)
plot(baseline, title="Long-Term Baseline", color=color.black, linewidth=2)
plot(0, title="Zero", color=color.gray, style=plot.style_line, linewidth=1)

bgcolor(in_position ? color.new(color.green, 95) : na, title="In Position")

var label filter_mode_label = na
label_y_position = ta.highest(short_term, 100)

if barstate.islast
    macro_status = use_macro_filter ? "MACRO ON" : "MACRO OFF"
    label_text = "📊 SIMPLE ALMA - " + macro_status
    label_color = use_macro_filter ? color.new(color.orange, 80) : color.new(color.green, 80)

    if na(filter_mode_label)
        filter_mode_label := label.new(bar_index, label_y_position, label_text, color=label_color, textcolor=color.white, style=label.style_label_down, size=size.small)
    else
        label.set_xy(filter_mode_label, bar_index, label_y_position)
        label.set_text(filter_mode_label, label_text)
        label.set_color(filter_mode_label, label_color)

plotshape(buy_signal and not in_position, "Buy", shape.triangleup, location.bottom, color.green, size=size.normal, text="BUY")
plotshape(trending_exit_trigger, "Trend Exit", shape.triangledown, location.top, color.red, size=size.normal, text="TREND")
plotshape(ranging_exit_trigger, "Range Exit", shape.triangledown, location.top, color.new(color.orange, 30), size=size.normal, text="RANGE")

blocked_by_momentum = bullish_state and not is_highest_close and use_momentum_filters and not in_position
plotshape(show_debug ? blocked_by_momentum : na, "Blocked", shape.xcross, location.bottom, color.orange, size=size.tiny, text="M")
